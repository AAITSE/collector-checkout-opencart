<modification>
    <name>Collector Checkout</name>
    <code>collector</code>
    <version>1.0</version>
    <author>AAIT</author>
    <link>https://aait.se/</link>
    <file path="catalog/controller/checkout/checkout.php">
        <operation>
            <search><![CDATA[
            $products = $this->cart->getProducts();
            ]]></search>
            <add position="before" offset="-1"><![CDATA[
            // Collector Checkout
            $this->load->model('setting/setting');
            $store_id = $this->config->get('config_store_id');
            $settings = $this->model_setting_setting->getSetting('collector', $store_id);
            if ($settings['collector_status']) {
                $this->response->redirect($this->url->link('checkout/collector'));
                return;
            }
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/product/category.php">
        <operation>
            <search><![CDATA[
            $this->document->setKeywords($category_info['meta_keyword']);
            ]]></search>
            <add position="after" offset="1"><![CDATA[
            $this->document->addScript('catalog/view/javascript/collector/instant-checkout.js');
            $this->load->model('collector/helper');
            $data['instant_checkout'] = $this->model_collector_helper->isInstantCheckoutEnabled();
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/product/product.php">
        <operation>
            <search><![CDATA[
            $this->document->addStyle('catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css');
            ]]></search>
            <add position="after" offset="1"><![CDATA[
            $this->document->addScript('catalog/view/javascript/collector/instant-checkout.js');
            $this->load->model('collector/helper');
            $data['instant_checkout'] = $this->model_collector_helper->isInstantCheckoutEnabled();
            ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/product/category.tpl">
        <operation>
            <search trim="true"><![CDATA[
            <button type="button" data-toggle="tooltip" title="<?php echo $button_compare; ?>" onclick="compare.add('<?php echo $product['product_id']; ?>');"><i class="fa fa-exchange"></i></button>
            ]]></search>
            <add position="after" offset="2"><![CDATA[
            <?php if ($instant_checkout): ?>
                <div class="button-group">
                    <input type="hidden" name="product_id" value="<?php echo $product['product_id']; ?>" />
                    <input type="hidden" name="quantity" value="1" />
                    <button type="button" class="collector-buy" style="width: 100%;"><i class="fa fa-shopping-cart"></i> Buy with Collector</button>
                </div>
            <?php endif; ?>
            ]]></add>
        </operation>
        <operation>
            <search trim="true"><![CDATA[
            <?php echo $footer; ?>
            ]]></search>
            <add position="before"><![CDATA[
<?php if ($instant_checkout): ?>
<div id="instant-checkout-lightbox-container" class="instant-checkout modal fade modal-window" role="dialog" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">Collector Checkout</h4>
            </div>
            <div class="modal-body">
                <!-- Modal content-->
                <script
                        type="text/javascript"
                        src="https://checkout-uat.collector.se/collector-instant-loader.js"
                        data-lang="sv-SE"
                        data-theme="core"
                        data-instance-id="INSTANT_CHECKOUT_MODAL">
                </script>
            </div>
        </div>
    </div>
</div>
<?php endif; ?>
            ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/product/product.tpl">
        <operation>
            <search trim="true"><![CDATA[
            <button type="button" id="button-cart" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg btn-block"><?php echo $button_cart; ?></button>
            ]]></search>
            <add position="after">
            <![CDATA[
              <?php if ($instant_checkout): ?>
              <button type="button" id="collector-buy" data-loading-text="<?php echo $text_loading; ?>" class="btn btn-primary btn-lg btn-block collector-buy">Buy with Collector</button>
              <?php endif; ?>
            ]]></add>
        </operation>
        <operation>
            <search trim="true"><![CDATA[
            <?php if ($minimum > 1) { ?>
            ]]></search>
            <add position="before"><![CDATA[
              <?php if ($instant_checkout): ?>
              <div id="instant-checkout-lightbox-container" class="instant-checkout modal fade modal-window" role="dialog"  aria-hidden="true" data-backdrop="static">
                  <div class="modal-dialog modal-dialog-centered">
                      <div class="modal-content">
                          <div class="modal-header">
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                              <h4 class="modal-title">Collector Checkout</h4>
                          </div>
                          <div class="modal-body">
                              <script
                                      type="text/javascript"
                                      src="https://checkout-uat.collector.se/collector-instant-loader.js"
                                      data-lang="sv-SE"
                                      data-theme="core"
                                      data-instance-id="INSTANT_CHECKOUT_MODAL">
                              </script>
                          </div>
                      </div>
                  </div>
              </div>
              <?php endif; ?>
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/sale/order.php">
        <operation>
            <search><![CDATA[
            $this->response->setOutput($this->load->view('sale/order_info', $data));
            ]]></search>
            <add position="before"><![CDATA[
            $this->load->model('collector/payments');
            $payment = $this->model_collector_payments->getByOrderId($order_id);
            if ($payment) {
                $data['collector'] = $payment;
                $data['collector']['action'] = html_entity_decode($this->url->link('collector/action', 'token=' . $this->session->data['token'], true));

                $info = json_decode($payment['info'], true);
                $data['collector']['items'] = [];
                foreach ($info['data']['order']['items'] as $item) {
                    $data['collector']['items'][] = [
                        'name' => $item['description'],
                        'unit_price' => $item['unitPrice'],
                        'qty' => $item['quantity'],
                        'vat' => $item['vat']
                    ];
                }
            }
            ]]></add>
        </operation>
    </file>

    <file path="admin/view/template/sale/order_info.tpl">
        <operation>
            <search trim="true"><![CDATA[
            <h3 class="panel-title"><i class="fa fa-comment-o"></i> <?php echo $text_history; ?></h3>
            ]]></search>
            <add position="before" offset="2"><![CDATA[
      <?php if (isset($collector)): ?>
      <div class="panel panel-default">
          <div class="panel-heading">
              <h3 class="panel-title"><i class="fa fa-shopping-cart"></i> Collector</h3>
          </div>
          <div class="panel-body">
              <table class="table">
                  <tbody>
                  <tr>
                      <td style="width: 10%;">
                          <strong>Payment Method</strong>
                      </td>
                      <td>
                          <?php echo $collector['paymentName']; ?>
                      </td>
                  </tr>
                  <tr>
                      <td style="width: 10%;">
                          <strong>Status</strong>
                      </td>
                      <td>
                          <?php echo $collector['status']; ?>
                      </td>
                  </tr>
                  <tr>
                      <td style="width: 10%;">
                          <strong>Purchase Id</strong>
                      </td>
                      <td>
                          <?php echo $collector['purchaseIdentifier']; ?>
                      </td>
                  </tr>
                  <tr>
                      <td style="width: 10%;">
                          <strong>Purchase Status</strong>
                      </td>
                      <td>
                          <?php echo $collector['purchaseStatus']; ?>
                      </td>
                  </tr>
                  <tr>
                      <td style="width: 10%;">
                          &nbsp;
                      </td>
                      <td>
                          <?php if ($collector['purchaseStatus'] === 'Preliminary' && !$collector['activated'] && !$collector['canceled']): ?>
                          <button data-id="<?php echo $collector['id']; ?>" data-action="activate" class="collector-action btn">Activate</button>
                          <?php endif; ?>
                          <?php if (!$collector['activated'] && !$collector['canceled']): ?>
                          <button data-id="<?php echo $collector['id']; ?>" data-action="cancel" class="collector-action btn">Cancel</button>
                          <?php endif; ?>
                          <?php if ($collector['activated'] && !$collector['credited']): ?>
                          <button data-id="<?php echo $collector['id']; ?>" data-action="credit" class="collector-action btn">Credit</button>
                          <?php endif; ?>
                          <?php if (in_array($collector['paymentName'], ['Invoice', 'DirectInvoice']) && !$collector['canceled'] && !$collector['credited']):?>
                            <?php if ($collector['activated']): ?>
                                <button data-id="<?php echo $collector['id']; ?>" data-action="send" class="collector-action btn">Send Invoice</button>
                            <?php endif; ?>
                            <?php if ($collector['activated'] && !$collector['extended']): ?>
                                <button data-id="<?php echo $collector['id']; ?>" data-action="extend" class="collector-action btn">Extend Due Date</button>
                            <?php endif; ?>
                          <?php endif; ?>
                      </td>
                  </tr>
                  </tbody>
              </table>
          </div>
      </div>
      <script>
          jQuery(document).ready(function($) {
              $(document).on('click', '.collector-action', function(e) {
                  var el = $(e.currentTarget),
                      id = el.data('id'),
                      action = el.data('action');

                  el.prop('disabled', true);

                  $.ajax({
                      url: '<?php echo $collector['action']; ?>',
                      method: 'post',
                      dataType: 'json',
                      data: {
                          action: action,
                          id: id
                      }
                  }).always(function () {
                      el.prop('disabled', false);
                  }).done(function (response) {
                      if (response.success) {
                          self.location.href = location.href;
                      } else {
                          alert(response.message)
                      }
                  });
              });
          });
      </script>
      <?php endif; ?>
            ]]></add>
        </operation>
    </file>
</modification>
